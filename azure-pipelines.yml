schedules:
  - cron: "0 0 * * *"
    displayName: Daily midnight build
    branches:
      include:
      - master
      - feature/*
resources:
  repositories:
    - repository: self
      persistCredentials: true
      clean: true

    - repository: RESAC
      type: github
      endpoint: S126-Tlevelservice
      name: SkillsFundingAgency/tl-results-and-certification
      ref: feature/sprint-18

    - repository: devopsTools
      type: github
      endpoint: DFE-Digital
      name: DFE-Digital/operations-devops-tools

    - repository: devopsTemplates
      type: github
      endpoint: DfE-Digital
      name: DFE-Digital/operations-devops-pipeline-templates
trigger:
  batch: true
  branches:
    include:
      - "*"
pr: none

variables:
  buildConfiguration: 'release'
  MSBUILDSINGLELOADCONTEXT: 1
  buildPlatform: 'anycpu'
  applicationName: 'resac automation'

stages:
  - stage: buildstage
    displayName: Build Stage
    jobs:
      - template: ./yaml/jobs/resac-build.yml
        parameters: 
          buildConfiguration: $(buildConfiguration)
      - template: ./yml/jobs/resac=-build-sql.yml

      
      
  - stage: CreateAutomationDatabaseTest
    displayName: Deploy Automation database 
    dependsOn:
      buildstage
    variables:
      - group: Test Shared Resources
      - group: Common Shared Resources
    jobs:      
      - job: deploysqldb
        displayName: Deploy SQL DB
        pool:
          name: 'Azure Pipelines'
          vmImage: 'windows-2019'
        steps:
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'sqldrop'
              downloadPath: '$(System.ArtifactsDirectory)'
          - task: SqlAzureDacpacDeployment@1
            inputs:
              azureSubscription: $(ServiceConnection)
              AuthenticationType: 'server'
              ServerName: '$(SharedSqlServerFQDN)'
              DatabaseName: '$(AutomationDatabaseName)'
              SqlUsername: '$(SharedSqlServerUsername)'
              SqlPassword: '$(SharedSqlServerPassword)'
              deployType: 'DacpacTask'
              DeploymentAction: 'Publish'
              DacpacFile: '$(System.ArtifactsDirectory)/sqldrop/src/Sfa.Tl.ResultsAndCertification.Database/bin/Release/Sfa.Tl.ResultsAndCertification.Database.dacpac'
              AdditionalArguments: '/v:environment=test'
              IpDetectionMethod: 'AutoDetect'
  - stage: Test
    displayName:  Test
    dependsOn:
      CreateAutomationDatabaseTest
    variables:
      - group: Test Shared Resources
      - group: Common Shared Resources
    jobs:
      - job: runTests
        displayName: Run the automation tests
        pool:
            name: 'Azure Pipelines'
            vmImage: 'windows-2019'
        steps:
          - checkout: devopsTools
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'appdrop'
              downloadPath: '$(System.ArtifactsDirectory)'          
          
          - task: Tokenization@2
            displayName: 'Tokenization: Transform file *.json'
            inputs:
              SourcePath: '$(System.ArtifactsDirectory)/appdrop/tests'
              TargetFileNames: '*.json'
          
          - task: VSTest@2
            displayName: 'VsTest - Test Execution'
            inputs:
              testAssemblyVer2: '**\SFA.Tl.ResultsAndCertificationAutomation.dll'
              searchFolder: '$(System.ArtifactsDirectory)/appdrop/tests/Sfa.Tl.ResultsAndCertificationAutomation/'
              runInParallel: false
              rerunFailedTests: true
            continueOnError: true
          
          - task: PowerShell@2
            displayName: 'Check .trx File Exists'
            inputs:
              targetType: filePath
              filePath: '$(System.ArtifactsDirectory)/appdrop/src/Sfa.Tl.ResultsAndCertificationAutomation/Check-TestResults.ps1'
              arguments: '-SourcePath "$(Agent.TempDirectory)/testresults"'

  - stage: PP
    displayName: Pre-Production
    dependsOn:
      buildstage
    variables:
      - group: PreProd Shared Resources
      - group: Common Shared Resources
    jobs:
    - job: runTests
      displayName: Run the automation tests
      pool:
          name: 'Azure Pipelines'
          vmImage: 'windows-2019'
      steps:
        - checkout: devopsTools
        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'appdrop'
            downloadPath: '$(System.ArtifactsDirectory)'
        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'sqldrop'
            downloadPath: '$(System.ArtifactsDirectory)'

        - task: Tokenization@2
          displayName: 'Tokenization: Transform file *.json'
          inputs:
            SourcePath: '$(System.ArtifactsDirectory)/appdrop/tests'
            TargetFileNames: '*.json'

        - task: VSTest@2
          displayName: 'VsTest - Test Execution'
          inputs:
            testAssemblyVer2: '**\SFA.Tl.ResultsAndCertificationAutomation.dll'
            searchFolder: '$(System.ArtifactsDirectory)/appdrop/tests/Sfa.Tl.ResultsAndCertificationAutomation/'
            testFiltercriteria: 'TestCategory=SmokeTest'
            runInParallel: false
            rerunFailedTests: true
          continueOnError: true

        - task: PowerShell@2
          displayName: 'Check .trx File Exists'
          inputs:
            targetType: filePath
            filePath: '$(System.ArtifactsDirectory)/appdrop/src/Sfa.Tl.ResultsAndCertificationAutomation/Check-TestResults.ps1'
            arguments: '-SourcePath "$(Agent.TempDirectory)/testresults"'

      